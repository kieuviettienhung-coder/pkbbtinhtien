<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Ph√≤ng Kh√°m B√°ch B·∫£o - Qu·∫£n L√Ω Thu Chi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* iOS Specific Optimizations */
        * {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            -webkit-touch-callout: none;
        }
        
        body {
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            -webkit-overflow-scrolling: touch;
        }
        
        /* Prevent zoom on input focus */
        input, select, textarea, button {
            font-size: 16px !important;
            min-height: 44px;
        }
        
        /* Smooth scrolling for iOS */
        .overflow-y-auto, .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Fix date picker on iOS */
        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
        }
        
        /* Better touch targets */
        button {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCzMwOcNCcEuFVFHjqMEmrlMQs7DG-z-QI",
            authDomain: "phongkhambachbao-a47bc.firebaseapp.com",
            databaseURL: "https://phongkhambachbao-a47bc-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "phongkhambachbao-a47bc",
            storageBucket: "phongkhambachbao-a47bc.firebasestorage.app",
            messagingSenderId: "484295663180",
            appId: "1:484295663180:web:29583f475b3b9fe2c7dee9"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // ===== REMOTE KILL SWITCH =====
        // Ki·ªÉm tra app c√≥ ƒë∆∞·ª£c ph√©p ch·∫°y kh√¥ng (ch·ªâ √°p d·ª•ng cho file C≈®)
        const CURRENT_APP_VERSION = '2.0.0'; // Version c·ªßa file n√†y
        db.ref('settings/appEnabled').once('value', (snapshot) => {
            const isEnabled = snapshot.val();
            
            // H√†m so s√°nh version
            const compareVersions = (v1, v2) => {
                const parts1 = v1.split('.').map(Number);
                const parts2 = v2.split('.').map(Number);
                for (let i = 0; i < 3; i++) {
                    if (parts1[i] > parts2[i]) return 1;
                    if (parts1[i] < parts2[i]) return -1;
                }
                return 0;
            };
            
            if (isEnabled === false) {
                // App b·ªã kh√≥a - NH∆ØNG cho ph√©p file v2.0.0+
                if (compareVersions(CURRENT_APP_VERSION, '2.0.0') >= 0) {
                    // File m·ªõi v2.0.0+ ‚Üí Cho ph√©p v√†o
                    console.log('‚úÖ File m·ªõi v' + CURRENT_APP_VERSION + ' - Kh√¥ng b·ªã kh√≥a');
                } else {
                    // File c≈© < v2.0.0 ‚Üí B·ªã kh√≥a
                    document.body.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 500px; text-align: center;">
                                <div style="font-size: 80px; margin-bottom: 20px;">üîí</div>
                                <h1 style="color: #e53e3e; font-size: 32px; margin-bottom: 10px;">Phi√™n b·∫£n c≈© ƒë√£ b·ªã kh√≥a</h1>
                                <p style="color: #4a5568; font-size: 18px; margin-bottom: 30px;">Vui l√≤ng c·∫≠p nh·∫≠t l√™n phi√™n b·∫£n m·ªõi nh·∫•t</p>
                                <div style="background: #fff5f5; border: 2px solid #feb2b2; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                                    <p style="color: #742a2a; font-size: 14px; margin: 0;">
                                        <strong>üìû Li√™n h·ªá Admin</strong><br/>
                                        ƒë·ªÉ l·∫•y file phi√™n b·∫£n m·ªõi
                                    </p>
                                </div>
                                <p style="color: #718096; font-size: 12px;">Ph√≤ng Kh√°m B√°ch B·∫£o ¬© 2025</p>
                            </div>
                        </div>
                    `;
                    throw new Error('Old app version locked by admin');
                }
            } else if (isEnabled === null) {
                // L·∫ßn ƒë·∫ßu ch·∫°y, t·ª± ƒë·ªông set = true
                db.ref('settings/appEnabled').set(true);
            }
        });

        // Default price levels
        const DEFAULT_PRICE_LEVELS = [0, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180, 190, 200, 220, 230, 260, 280, 300, 320];

        function App() {
            // ===== VERSION CONTROL =====
            const APP_VERSION = '2.0.0'; // TƒÉng s·ªë n√†y khi c√≥ b·∫£n m·ªõi
            const [versionBlocked, setVersionBlocked] = useState(false);
            const [requiredVersion, setRequiredVersion] = useState('');
            
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState(null); // 'admin' or 'staff'
            const [allowedBranch, setAllowedBranch] = useState(null); // 'nga-bay', 'thot-not', or 'all'
            const [currentView, setCurrentView] = useState('input');
            const [selectedBranch, setSelectedBranch] = useState('nga-bay');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [dailyData, setDailyData] = useState({
                examinations: {},
                expenses: [],
                doctorFees: [],
                medicines: []
            });
            const [monthlyData, setMonthlyData] = useState({});
            const [monthlyMedicines, setMonthlyMedicines] = useState({});
            const [yearlyData, setYearlyData] = useState({});
            const [customPrices, setCustomPrices] = useState([]);
            const [showLogin, setShowLogin] = useState(true);
            const [adminPassword, setAdminPassword] = useState('123456');
            const [adminNgaBayPassword, setAdminNgaBayPassword] = useState('adminngabay123');
            const [ngaBayPassword, setNgaBayPassword] = useState('ngabay123');
            const [thotNotPassword, setThotNotPassword] = useState('thotnot123');
            const [medicineList, setMedicineList] = useState([
                { name: 'adkold new', price: 30 },
                { name: 'air x cam', price: 50 },
                { name: 'albendazol 400mg', price: 30 },
                { name: 'augmentin 1g', price: 240 },
                { name: 'augmentin 500mg', price: 200 },
                { name: 'augxicine 500mg', price: 180 },
                { name: 'betamethasone', price: 70 },
                { name: 'cefixim 100mg', price: 150 },
                { name: 'cefpodoxim 100mg', price: 160 },
                { name: 'claminat 500mg', price: 190 },
                { name: 'curam 1g', price: 250 },
                { name: 'd3 mk7', price: 85 },
                { name: 'desloratadin 5mg', price: 50 },
                { name: 'dexipharm 5mg', price: 15 },
                { name: 'dibencozide', price: 40 },
                { name: 'domperidon 5mg', price: 20 },
                { name: 'dorogyne f', price: 120 },
                { name: 'dr nasal kids', price: 55 },
                { name: 'enokast 4mg', price: 110 },
                { name: 'esomeprazol 20mg', price: 80 },
                { name: 'farzincol', price: 50 },
                { name: 'fendexi', price: 45 },
                { name: 'fendexi forte', price: 55 },
                { name: 'ferumpro', price: 80 },
                { name: 'germany ƒÉn ngon', price: 75 },
                { name: 'hidrasec', price: 95 },
                { name: 'ho propa', price: 25 },
                { name: 'ibu chai', price: 35 },
                { name: 'ibu siro', price: 40 },
                { name: 'jolli gold', price: 70 },
                { name: 'katrypsin', price: 80 },
                { name: 'konimag', price: 65 },
                { name: 'mask phun', price: 20 },
                { name: 'menpeptine', price: 45 },
                { name: 'metpredni 16mg', price: 60 },
                { name: 'mg b6', price: 35 },
                { name: 'natri clorid 0.9%', price: 15 },
                { name: 'paracetamol 500mg', price: 10 },
                { name: 'peg 3350', price: 95 },
                { name: 'pharlac vital', price: 90 },
                { name: 'povidine 10%', price: 60 },
                { name: 'prosbee v√†ng', price: 100 },
                { name: 'sachaces', price: 75 },
                { name: 'saccha vital', price: 85 },
                { name: 'salbutamol', price: 40 },
                { name: 'simguline 5mg', price: 90 },
                { name: 'sterimux baby', price: 45 },
                { name: 'terpin mekong', price: 25 },
                { name: 'zaromax 100mg', price: 120 },
                { name: 'zaromax 200mg', price: 180 }
            ]);

            // Load passwords from Firebase on mount
            useEffect(() => {
                // Ki·ªÉm tra v√† t·ª± ƒë·ªông set minVersion n·∫øu ch∆∞a c√≥
                db.ref('settings_v2/minVersion').once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        // Ch∆∞a c√≥ minVersion ‚Üí T·ª± ƒë·ªông set = APP_VERSION
                        db.ref('settings_v2/minVersion').set(APP_VERSION);
                        console.log('‚úÖ ƒê√£ t·ª± ƒë·ªông set minVersion =', APP_VERSION);
                    } else {
                        // ƒê√£ c√≥ minVersion ‚Üí Ki·ªÉm tra
                        const minVersion = snapshot.val();
                        if (compareVersions(APP_VERSION, minVersion) < 0) {
                            setVersionBlocked(true);
                            setRequiredVersion(minVersion);
                            return;
                        }
                    }
                });

                db.ref('settings_v2/adminPassword').once('value', (snapshot) => {
                    if (snapshot.val()) {
                        setAdminPassword(snapshot.val());
                    }
                });
                db.ref('settings_v2/adminNgaBayPassword').once('value', (snapshot) => {
                    if (snapshot.val()) {
                        setAdminNgaBayPassword(snapshot.val());
                    }
                });
                db.ref('settings_v2/ngaBayPassword').once('value', (snapshot) => {
                    if (snapshot.val()) {
                        setNgaBayPassword(snapshot.val());
                    }
                });
                db.ref('settings_v2/thotNotPassword').once('value', (snapshot) => {
                    if (snapshot.val()) {
                        setThotNotPassword(snapshot.val());
                    }
                });
                db.ref('settings_v2/medicineList').once('value', (snapshot) => {
                    if (snapshot.val()) {
                        setMedicineList(snapshot.val());
                    }
                });
            }, []);

            // Function to compare versions (returns -1 if v1 < v2, 0 if equal, 1 if v1 > v2)
            const compareVersions = (v1, v2) => {
                const parts1 = v1.split('.').map(Number);
                const parts2 = v2.split('.').map(Number);
                for (let i = 0; i < 3; i++) {
                    if (parts1[i] > parts2[i]) return 1;
                    if (parts1[i] < parts2[i]) return -1;
                }
                return 0;
            };

            const changePassword = async () => {
                let passwordType = 'admin';
                let currentPassword = adminPassword;
                let dbPath = 'settings_v2/adminPassword';
                let setPasswordFunc = setAdminPassword;
                
                if (userRole === 'staff') {
                    if (allowedBranch === 'nga-bay') {
                        passwordType = 'Ng√£ B·∫£y';
                        currentPassword = ngaBayPassword;
                        dbPath = 'settings_v2/ngaBayPassword';
                        setPasswordFunc = setNgaBayPassword;
                    } else {
                        passwordType = 'Th·ªët N·ªët';
                        currentPassword = thotNotPassword;
                        dbPath = 'settings_v2/thotNotPassword';
                        setPasswordFunc = setThotNotPassword;
                    }
                }
                
                const currentPass = prompt(`Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i (${passwordType}):`);
                if (!currentPass) {
                    return; // User cancelled
                }
                
                if (currentPass !== currentPassword) {
                    alert('‚ùå M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng!');
                    return;
                }
                
                const newPass = prompt('Nh·∫≠p m·∫≠t kh·∫©u m·ªõi:');
                if (!newPass) {
                    return; // User cancelled
                }
                
                if (newPass.length < 4) {
                    alert('‚ùå M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 4 k√Ω t·ª±!');
                    return;
                }
                
                const confirmPass = prompt('Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi:');
                if (!confirmPass) {
                    return; // User cancelled
                }
                
                if (newPass !== confirmPass) {
                    alert('‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
                    return;
                }
                
                try {
                    await db.ref(dbPath).set(newPass);
                    setPasswordFunc(newPass);
                    alert('‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!');
                } catch (error) {
                    console.error('Error changing password:', error);
                    alert('‚ùå L·ªói khi ƒë·ªïi m·∫≠t kh·∫©u: ' + error.message + '\n\nVui l√≤ng ki·ªÉm tra:\n1. K·∫øt n·ªëi Internet\n2. Quy·ªÅn ghi Firebase Database');
                }
            };

            const managePasswords = async () => {
                if (userRole !== 'admin') {
                    alert('‚ùå Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn qu·∫£n l√Ω t√†i kho·∫£n!');
                    return;
                }

                const accounts = [
                    { name: 'üë®‚Äçüíº Admin (To√†n quy·ªÅn)', role: 'admin', path: 'passwords_v2/admin', currentPass: adminPassword, setter: setAdminPassword },
                    { name: 'üë®‚Äçüíº Admin Ng√£ B·∫£y', role: 'admin-nga-bay', path: 'passwords_v2/admin-nga-bay', currentPass: adminNgaBayPassword, setter: setAdminNgaBayPassword },
                    { name: 'üë®‚Äçüíª Nh√¢n vi√™n Ng√£ B·∫£y', role: 'nga-bay', path: 'passwords_v2/nga-bay', currentPass: ngaBayPassword, setter: setNgaBayPassword },
                    { name: 'üë®‚Äçüíª Nh√¢n vi√™n Th·ªët N·ªët', role: 'thot-not', path: 'passwords_v2/thot-not', currentPass: thotNotPassword, setter: setThotNotPassword }
                ];

                let message = 'üë• QU·∫¢N L√ù T√ÄI KHO·∫¢N\n\n';
                message += 'Ch·ªçn t√†i kho·∫£n c·∫ßn ƒë·ªïi m·∫≠t kh·∫©u:\n\n';
                accounts.forEach((acc, i) => {
                    message += `${i + 1}. ${acc.name}\n`;
                });
                message += '\nNh·∫≠p s·ªë (1-4) ho·∫∑c 0 ƒë·ªÉ h·ªßy:';

                const choice = prompt(message);
                if (!choice || choice === '0') return;

                const index = parseInt(choice) - 1;
                if (index < 0 || index >= accounts.length) {
                    alert('‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!');
                    return;
                }

                const account = accounts[index];
                
                const newPass = prompt(`üîê ƒê·ªïi m·∫≠t kh·∫©u cho: ${account.name}\n\nNh·∫≠p m·∫≠t kh·∫©u m·ªõi:`);
                if (!newPass) return;
                
                if (newPass.length < 4) {
                    alert('‚ùå M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 4 k√Ω t·ª±!');
                    return;
                }
                
                const confirmPass = prompt('Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi ƒë·ªÉ x√°c nh·∫≠n:');
                if (!confirmPass) return;
                
                if (newPass !== confirmPass) {
                    alert('‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
                    return;
                }
                
                try {
                    await db.ref(account.path).set(newPass);
                    account.setter(newPass);
                    alert(`‚úÖ ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng cho: ${account.name}`);
                } catch (error) {
                    console.error('Error changing password:', error);
                    alert('‚ùå L·ªói khi ƒë·ªïi m·∫≠t kh·∫©u: ' + error.message);
                }
            };

            const updateMinVersion = async () => {
                if (userRole !== 'admin') {
                    alert('‚ùå Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn c·∫≠p nh·∫≠t version!');
                    return;
                }

                const currentMinVersion = await db.ref('settings_v2/minVersion').once('value').then(s => s.val() || '1.0.0');
                
                let message = 'üîÑ C·∫¨P NH·∫¨T PHI√äN B·∫¢N T·ªêI THI·ªÇU\n\n';
                message += `üì± File hi·ªán t·∫°i: ${APP_VERSION}\n`;
                message += `üîí Phi√™n b·∫£n t·ªëi thi·ªÉu hi·ªán t·∫°i: ${currentMinVersion}\n\n`;
                message += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n';
                message += '‚ö†Ô∏è Ch·∫∑n t·∫•t c·∫£ file c≈©?\n\n';
                message += 'Nh·∫≠p "YES" ƒë·ªÉ c·∫≠p nh·∫≠t minVersion = ' + APP_VERSION + '\n';
                message += '(T·∫•t c·∫£ file < ' + APP_VERSION + ' s·∫Ω b·ªã ch·∫∑n)';

                const confirm = prompt(message);
                
                if (confirm === 'YES') {
                    try {
                        await db.ref('settings_v2/minVersion').set(APP_VERSION);
                        alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t!\n\nminVersion = ${APP_VERSION}\n\nT·∫•t c·∫£ file c≈© h∆°n ${APP_VERSION} gi·ªù s·∫Ω b·ªã ch·∫∑n.`);
                    } catch (error) {
                        alert('‚ùå L·ªói: ' + error.message);
                    }
                } else {
                    alert('‚ùå ƒê√£ h·ªßy');
                }
            };

            const toggleAppEnabled = async () => {
                if (userRole !== 'admin') {
                    alert('‚ùå Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn kh√≥a app!');
                    return;
                }

                const currentStatus = await db.ref('settings/appEnabled').once('value').then(s => s.val());
                
                if (currentStatus === false) {
                    // ƒêang kh√≥a ‚Üí M·ªü
                    const confirm = window.confirm('üîì M·ªû KH√ìA T·∫§T C·∫¢ APP?\n\nT·∫•t c·∫£ file (c≈© v√† m·ªõi) s·∫Ω ho·∫°t ƒë·ªông tr·ªü l·∫°i.');
                    if (confirm) {
                        await db.ref('settings/appEnabled').set(true);
                        alert('‚úÖ ƒê√£ m·ªü kh√≥a! T·∫•t c·∫£ app c√≥ th·ªÉ v√†o l·∫°i.');
                    }
                } else {
                    // ƒêang m·ªü ‚Üí Kh√≥a
                    let message = 'üîí KH√ìA T·∫§T C·∫¢ APP C≈®?\n\n';
                    message += '‚ö†Ô∏è C·∫¢NH B√ÅO NGHI√äM TR·ªåNG:\n\n';
                    message += '‚Ä¢ T·∫§T C·∫¢ file c≈© s·∫Ω B·ªä KH√ìA NGAY L·∫¨P T·ª®C\n';
                    message += '‚Ä¢ File hi·ªán t·∫°i (v' + APP_VERSION + ') V·∫™N HO·∫†T ƒê·ªòNG\n';
                    message += '‚Ä¢ D√πng ƒë·ªÉ BU·ªòC t·∫•t c·∫£ ph·∫£i update\n\n';
                    message += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n';
                    message += 'Nh·∫≠p "KHOA" (vi·∫øt hoa) ƒë·ªÉ x√°c nh·∫≠n:';
                    
                    const confirm = prompt(message);
                    
                    if (confirm === 'KHOA') {
                        await db.ref('settings/appEnabled').set(false);
                        alert('üîí ƒê√É KH√ìA!\n\nT·∫•t c·∫£ file c≈© gi·ªù kh√¥ng th·ªÉ m·ªü ƒë∆∞·ª£c.\n\nƒê·ªÉ m·ªü l·∫°i: Click n√∫t "üîí Kh√≥a app c≈©" l·∫ßn n·ªØa.');
                    } else {
                        alert('‚ùå ƒê√£ h·ªßy');
                    }
                }
            };

            // Load data when date/branch changes
            useEffect(() => {
                if (user) {
                    loadDailyData();
                    loadCustomPrices();
                }
            }, [selectedBranch, selectedDate, user]);

            // Reload report data when branch changes
            useEffect(() => {
                if (user && userRole === 'admin') {
                    if (currentView === 'report') {
                        loadMonthlyData();
                    } else if (currentView === 'yearly') {
                        loadYearlyData();
                    }
                }
            }, [selectedBranch, selectedDate, currentView]);

            const loadCustomPrices = () => {
                db.ref(`settings_v2/customPrices/${selectedBranch}`).once('value', (snapshot) => {
                    const prices = snapshot.val() || [];
                    setCustomPrices(prices);
                });
            };

            const saveCustomPrices = (prices) => {
                db.ref(`settings_v2/customPrices/${selectedBranch}`).set(prices);
                setCustomPrices(prices);
            };

            const loadDailyData = () => {
                const dateKey = selectedDate.replace(/-/g, '');
                const dataRef = db.ref(`daily_v2/${selectedBranch}/${dateKey}`);
                
                dataRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setDailyData(data);
                    } else {
                        setDailyData({
                            examinations: {},
                            expenses: [],
                            doctorFees: []
                        });
                    }
                });

                return () => dataRef.off();
            };

            const loadMonthlyData = () => {
                const year = selectedDate.substring(0, 4);
                const month = selectedDate.substring(5, 7);
                const monthKey = year + month;
                
                const dataRef = db.ref(`daily_v2/${selectedBranch}`);
                dataRef.orderByKey().startAt(monthKey + '01').endAt(monthKey + '31').once('value', (snapshot) => {
                    const data = {};
                    snapshot.forEach((child) => {
                        data[child.key] = child.val();
                    });
                    setMonthlyData(data);
                });
            };

            const loadYearlyData = () => {
                const year = selectedDate.substring(0, 4);
                const startKey = year + '0101';
                const endKey = year + '1231';
                
                const dataRef = db.ref(`daily_v2/${selectedBranch}`);
                dataRef.orderByKey().startAt(startKey).endAt(endKey).once('value', (snapshot) => {
                    const data = {};
                    snapshot.forEach((child) => {
                        data[child.key] = child.val();
                    });
                    setYearlyData(data);
                });
            };

            const loadMonthlyMedicineData = () => {
                const year = selectedDate.substring(0, 4);
                const month = selectedDate.substring(5, 7);
                const monthKey = year + month;
                
                const medicineRef = db.ref(`monthlyMedicines/${selectedBranch}/${monthKey}`);
                medicineRef.once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setMonthlyMedicines(data);
                    } else {
                        setMonthlyMedicines({ medicines: [] });
                    }
                });
            };

            const saveMonthlyMedicines = async (medicines) => {
                try {
                    const year = selectedDate.substring(0, 4);
                    const month = selectedDate.substring(5, 7);
                    const monthKey = year + month;
                    
                    await db.ref(`monthlyMedicines/${selectedBranch}/${monthKey}`).set({
                        medicines: medicines,
                        month: `${year}-${month}`,
                        updatedAt: new Date().toISOString(),
                        updatedBy: userRole
                    });
                    
                    setMonthlyMedicines({ medicines: medicines });
                    alert('‚úÖ ƒê√£ l∆∞u ti·ªÅn thu·ªëc th√°ng th√†nh c√¥ng!');
                } catch (error) {
                    alert('‚ùå L·ªói khi l∆∞u: ' + error.message);
                }
            };

            const handleLogin = () => {
                // H·ªèi m·∫≠t kh·∫©u
                const password = prompt('üîê Nh·∫≠p m·∫≠t kh·∫©u:');
                if (!password) return;

                // Ki·ªÉm tra Admin (to√†n quy·ªÅn)
                if (password === adminPassword) {
                    setUser({ role: 'admin', branch: null });
                    setUserRole('admin');
                    setAllowedBranch('all');
                    setShowLogin(false);
                    return;
                }

                // Ki·ªÉm tra Admin Ng√£ B·∫£y (admin nh∆∞ng ch·ªâ th·∫•y Ng√£ B·∫£y)
                if (password === adminNgaBayPassword) {
                    setUser({ role: 'admin', branch: 'nga-bay' });
                    setUserRole('admin');
                    setAllowedBranch('nga-bay');
                    setSelectedBranch('nga-bay');
                    setShowLogin(false);
                    return;
                }

                // Ki·ªÉm tra Nh√¢n vi√™n Ng√£ B·∫£y
                if (password === ngaBayPassword) {
                    setUser({ role: 'staff', branch: 'nga-bay' });
                    setUserRole('staff');
                    setAllowedBranch('nga-bay');
                    setSelectedBranch('nga-bay');
                    setShowLogin(false);
                    return;
                }

                // Ki·ªÉm tra Nh√¢n vi√™n Th·ªët N·ªët
                if (password === thotNotPassword) {
                    setUser({ role: 'staff', branch: 'thot-not' });
                    setUserRole('staff');
                    setAllowedBranch('thot-not');
                    setSelectedBranch('thot-not');
                    setShowLogin(false);
                    return;
                }

                // Sai m·∫≠t kh·∫©u
                alert('‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
            };

            const handleLogout = () => {
                setUser(null);
                setUserRole(null);
                setAllowedBranch(null);
                setShowLogin(true);
                setCurrentView('input');
                setSelectedBranch('nga-bay');
            };

            const saveData = async () => {
                try {
                    const dateKey = selectedDate.replace(/-/g, '');
                    await db.ref(`daily_v2/${selectedBranch}/${dateKey}`).set({
                        ...dailyData,
                        branch: selectedBranch,
                        date: selectedDate,
                        updatedAt: new Date().toISOString(),
                        updatedBy: userRole
                    });
                    alert('‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu th√†nh c√¥ng!');
                } catch (error) {
                    alert('‚ùå L·ªói khi l∆∞u: ' + error.message);
                }
            };

            const calculateTotals = () => {
                const examTotal = Object.entries(dailyData.examinations || {})
                    .filter(([price, count]) => count && parseFloat(count) > 0)
                    .reduce((sum, [price, count]) => {
                        return sum + (parseFloat(price) * parseFloat(count));
                    }, 0);

                const expenseTotal = (dailyData.expenses || []).reduce((sum, exp) => {
                    return sum + parseFloat(exp.amount || 0);
                }, 0);

                const doctorTotal = (dailyData.doctorFees || []).reduce((sum, fee) => {
                    return sum + parseFloat(fee.amount || 0);
                }, 0);

                const medicineTotal = (dailyData.medicines || []).reduce((sum, med) => {
                    return sum + (parseFloat(med.quantity || 0) * parseFloat(med.price || 0));
                }, 0);

                return {
                    examTotal,
                    expenseTotal,
                    doctorTotal,
                    medicineTotal,
                    grandTotal: examTotal - expenseTotal - doctorTotal - medicineTotal
                };
            };

            // Version Blocked Screen
            if (versionBlocked) {
                return (
                    <div className="flex items-center justify-center min-h-screen px-4 bg-red-50">
                        <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border-4 border-red-500">
                            <div className="text-center mb-6">
                                <div className="text-6xl mb-4">üö´</div>
                                <h1 className="text-3xl font-bold text-red-600 mb-2">
                                    Phi√™n b·∫£n c≈©
                                </h1>
                                <p className="text-gray-700 text-lg">
                                    Vui l√≤ng c·∫≠p nh·∫≠t phi√™n b·∫£n m·ªõi
                                </p>
                            </div>
                            
                            <div className="bg-red-50 border-2 border-red-300 rounded-lg p-4 mb-6">
                                <div className="space-y-2 text-sm">
                                    <p className="text-gray-700">
                                        <span className="font-semibold">Phi√™n b·∫£n hi·ªán t·∫°i:</span>
                                        <span className="ml-2 text-red-600 font-mono">{APP_VERSION}</span>
                                    </p>
                                    <p className="text-gray-700">
                                        <span className="font-semibold">Phi√™n b·∫£n y√™u c·∫ßu:</span>
                                        <span className="ml-2 text-green-600 font-mono">{requiredVersion}</span>
                                    </p>
                                </div>
                            </div>

                            <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                                <p className="text-sm text-gray-700">
                                    <span className="font-semibold text-yellow-700">‚ö†Ô∏è H∆∞·ªõng d·∫´n:</span><br/>
                                    1. Li√™n h·ªá Admin ƒë·ªÉ l·∫•y file m·ªõi<br/>
                                    2. T·∫£i file <code className="bg-gray-200 px-1 rounded">clinic-final.html</code> m·ªõi nh·∫•t<br/>
                                    3. M·ªü file m·ªõi trong tr√¨nh duy·ªát<br/>
                                    4. X√≥a file c≈© ƒë·ªÉ tr√°nh nh·∫ßm l·∫´n
                                </p>
                            </div>

                            <div className="mt-6 text-center">
                                <p className="text-xs text-gray-500">
                                    Ph√≤ng Kh√°m B√°ch B·∫£o - Version Control
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            // Login Screen
            if (showLogin) {
                return (
                    <div className="flex items-center justify-center min-h-screen px-4">
                        <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full">
                            <div className="text-center mb-8">
                                <h1 className="text-4xl font-bold text-blue-600 mb-2">
                                    Ph√≤ng Kh√°m B√°ch B·∫£o
                                </h1>
                                <p className="text-gray-600">H·ªá th·ªëng qu·∫£n l√Ω thu chi</p>
                            </div>
                            
                            <div className="space-y-4">
                                <button
                                    onClick={() => handleLogin()}
                                    className="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white py-4 rounded-xl font-bold text-lg hover:from-purple-700 hover:to-purple-800 transition shadow-lg transform hover:scale-105"
                                >
                                    üîê ƒêƒÉng nh·∫≠p
                                </button>
                            </div>

                            <div className="mt-6 text-center">
                                <p className="text-xs text-gray-500">
                                    ¬© 2025 Ph√≤ng Kh√°m B√°ch B·∫£o - Qu·∫£n l√Ω n·ªôi b·ªô
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            const totals = calculateTotals();
            
            // Check if readonly (staff viewing old date)
            const today = new Date().toISOString().split('T')[0];
            const isReadOnly = userRole === 'staff' && selectedDate !== today;

            return (
                <div className="container mx-auto px-4 py-6 max-w-7xl">
                    {/* Header */}
                    <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div className="flex justify-between items-center mb-4">
                            <div>
                                <h1 className="text-3xl font-bold text-blue-600">Ph√≤ng Kh√°m B√°ch B·∫£o</h1>
                                <p className="text-sm text-gray-600 mt-1">H·ªá th·ªëng qu·∫£n l√Ω thu chi</p>
                            </div>
                            <div className="flex gap-2">
                                {userRole === 'admin' && (
                                    <>
                                        <button
                                            onClick={toggleAppEnabled}
                                            className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition font-semibold"
                                            title="Kh√≥a t·∫•t c·∫£ file c≈©"
                                        >
                                            üîí Kh√≥a app c≈©
                                        </button>
                                        <button
                                            onClick={updateMinVersion}
                                            className="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition font-semibold"
                                            title="Ch·∫∑n phi√™n b·∫£n c≈©"
                                        >
                                            üîÑ C·∫≠p nh·∫≠t version
                                        </button>
                                        <button
                                            onClick={managePasswords}
                                            className="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition font-semibold"
                                        >
                                            üë• Qu·∫£n l√Ω t√†i kho·∫£n
                                        </button>
                                    </>
                                )}
                                <button
                                    onClick={handleLogout}
                                    className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition font-semibold"
                                >
                                    üö™ ƒêƒÉng xu·∫•t
                                </button>
                            </div>
                        </div>
                        
                        {/* Navigation */}
                        <div className="flex gap-2 mb-4 flex-wrap">
                            <button
                                onClick={() => setCurrentView('input')}
                                className={`px-4 py-2 rounded-lg font-semibold transition ${
                                    currentView === 'input'
                                        ? 'bg-blue-600 text-white'
                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                }`}
                            >
                                üìù Nh·∫≠p li·ªáu
                            </button>
                            {userRole === 'admin' && (
                                <>
                                    <button
                                        onClick={() => {
                                            setCurrentView('report');
                                            loadMonthlyData();
                                        }}
                                        className={`px-4 py-2 rounded-lg font-semibold transition ${
                                            currentView === 'report'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        üìä B√°o c√°o th√°ng
                                    </button>
                                    <button
                                        onClick={() => {
                                            setCurrentView('yearly');
                                            loadYearlyData();
                                        }}
                                        className={`px-4 py-2 rounded-lg font-semibold transition ${
                                            currentView === 'yearly'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        üìÖ B√°o c√°o nƒÉm
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('medicine')}
                                        className={`px-4 py-2 rounded-lg font-semibold transition ${
                                            currentView === 'medicine'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        ‚öôÔ∏è Qu·∫£n l√Ω thu·ªëc
                                    </button>
                                </>
                            )}
                        </div>

                        {/* Branch & Date Selection */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Chi nh√°nh</label>
                                {allowedBranch === 'all' ? (
                                    <select
                                        value={selectedBranch}
                                        onChange={(e) => setSelectedBranch(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="nga-bay">üè• Ng√£ B·∫£y</option>
                                        <option value="thot-not">üè• Th·ªët N·ªët</option>
                                    </select>
                                ) : (
                                    <div className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-700 font-semibold">
                                        üè• {selectedBranch === 'nga-bay' ? 'Ng√£ B·∫£y' : 'Th·ªët N·ªët'} (Chi nh√°nh c·ªßa b·∫°n)
                                    </div>
                                )}
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Ng√†y</label>
                                <input
                                    type="date"
                                    value={selectedDate}
                                    onChange={(e) => setSelectedDate(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    {currentView === 'input' && (
                        <div className="space-y-6">
                            {/* Readonly Warning */}
                            {isReadOnly && (
                                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                                    <div className="flex">
                                        <div className="flex-shrink-0">
                                            <svg className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                            </svg>
                                        </div>
                                        <div className="ml-3">
                                            <p className="text-sm text-yellow-700 font-semibold">
                                                ‚ö†Ô∏è Ch·∫ø ƒë·ªô xem - B·∫°n ch·ªâ c√≥ th·ªÉ xem d·ªØ li·ªáu ng√†y c≈©, kh√¥ng th·ªÉ ch·ªânh s·ª≠a. Vui l√≤ng ch·ªçn ng√†y h√¥m nay ƒë·ªÉ nh·∫≠p li·ªáu.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Examination Fees */}
                            <ExaminationSection 
                                examinations={dailyData.examinations || {}}
                                onChange={(exams) => setDailyData({...dailyData, examinations: exams})}
                                readOnly={isReadOnly}
                                customPrices={customPrices}
                                saveCustomPrices={saveCustomPrices}
                            />

                            {/* Doctor Fees */}
                            <DoctorFeesSection 
                                doctorFees={dailyData.doctorFees || []}
                                onChange={(fees) => setDailyData({...dailyData, doctorFees: fees})}
                                readOnly={isReadOnly}
                            />

                            {/* Expenses */}
                            <ExpensesSection 
                                expenses={dailyData.expenses || []}
                                onChange={(expenses) => setDailyData({...dailyData, expenses: expenses})}
                                readOnly={isReadOnly}
                            />

                            {/* Medicines */}
                            <MedicineSection 
                                medicines={dailyData.medicines || []}
                                medicineList={medicineList}
                                onChange={(medicines) => setDailyData({...dailyData, medicines: medicines})}
                                readOnly={isReadOnly}
                            />

                            {/* Summary */}
                            <div className="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg shadow-md p-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">üìä T·ªïng k·∫øt ng√†y {selectedDate}</h2>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center p-3 bg-white rounded-lg">
                                        <span className="font-semibold text-gray-700">üí∞ Ti·ªÅn kh√°m:</span>
                                        <span className="text-green-600 font-bold text-xl">+{totals.examTotal.toLocaleString()}k</span>
                                    </div>
                                    <div className="flex justify-between items-center p-3 bg-white rounded-lg">
                                        <span className="font-semibold text-gray-700">üë®‚Äç‚öïÔ∏è L∆∞∆°ng b√°c sƒ©:</span>
                                        <span className="text-blue-600 font-bold text-xl">-{totals.doctorTotal.toLocaleString()}k</span>
                                    </div>
                                    <div className="flex justify-between items-center p-3 bg-white rounded-lg">
                                        <span className="font-semibold text-gray-700">üí∏ Ti·ªÅn chi:</span>
                                        <span className="text-orange-600 font-bold text-xl">-{totals.expenseTotal.toLocaleString()}k</span>
                                    </div>
                                    <div className="flex justify-between items-center p-3 bg-white rounded-lg">
                                        <span className="font-semibold text-gray-700">üíä Ti·ªÅn thu·ªëc:</span>
                                        <span className="text-purple-600 font-bold text-xl">-{totals.medicineTotal.toLocaleString()}k</span>
                                    </div>
                                    <hr className="my-2 border-gray-300"/>
                                    <div className="flex justify-between items-center p-4 bg-white rounded-lg border-2 border-green-500">
                                        <span className="font-bold text-lg text-gray-800">üíµ C√≤n l·∫°i:</span>
                                        <span className={`font-bold text-2xl ${totals.grandTotal >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            {totals.grandTotal >= 0 ? '+' : ''}{totals.grandTotal.toLocaleString()}k
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {/* Save Button */}
                            <button
                                onClick={saveData}
                                disabled={isReadOnly}
                                className={`w-full py-4 rounded-lg font-bold text-lg transition shadow-lg transform ${
                                    isReadOnly 
                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                                        : 'bg-gradient-to-r from-blue-600 to-blue-700 text-white hover:from-blue-700 hover:to-blue-800 hover:scale-105'
                                }`}
                            >
                                {isReadOnly ? 'üîí Ch·∫ø ƒë·ªô xem - Kh√¥ng th·ªÉ l∆∞u' : 'üíæ L∆∞u d·ªØ li·ªáu'}
                            </button>
                        </div>
                    )}

                    {currentView === 'report' && userRole === 'admin' && (
                        <ReportView 
                            selectedBranch={selectedBranch}
                            selectedDate={selectedDate}
                            monthlyData={monthlyData}
                        />
                    )}

                    {currentView === 'yearly' && userRole === 'admin' && (
                        <YearlyReportView 
                            selectedBranch={selectedBranch}
                            selectedDate={selectedDate}
                            yearlyData={yearlyData}
                        />
                    )}

                    {currentView === 'medicine' && userRole === 'admin' && (
                        <MedicineManagement 
                            medicineList={medicineList}
                            setMedicineList={setMedicineList}
                        />
                    )}
                </div>
            );
        }

        // Yearly Report View Component
        function YearlyReportView({ selectedBranch, selectedDate, yearlyData }) {
            const year = selectedDate.substring(0, 4);

            // Group data by month
            const monthlyGroups = {};
            for (let month = 1; month <= 12; month++) {
                const monthKey = month.toString().padStart(2, '0');
                monthlyGroups[monthKey] = [];
            }

            Object.entries(yearlyData).forEach(([dateKey, dayData]) => {
                const month = dateKey.substring(4, 6);
                if (monthlyGroups[month]) {
                    monthlyGroups[month].push(dayData);
                }
            });

            const calculateMonthTotals = (monthData) => {
                let examTotal = 0, doctorTotal = 0, expenseTotal = 0, medicineTotal = 0, totalCases = 0, zeroCases = 0;

                monthData.forEach(dayData => {
                    examTotal += Object.entries(dayData.examinations || {})
                        .filter(([price, count]) => count && parseFloat(count) > 0)
                        .reduce((sum, [price, count]) => {
                            return sum + (parseFloat(price) * parseFloat(count));
                        }, 0);

                    doctorTotal += (dayData.doctorFees || []).reduce((sum, fee) => {
                        return sum + parseFloat(fee.amount || 0);
                    }, 0);

                    expenseTotal += (dayData.expenses || []).reduce((sum, exp) => {
                        return sum + parseFloat(exp.amount || 0);
                    }, 0);

                    medicineTotal += (dayData.medicines || []).reduce((sum, med) => {
                        return sum + (parseFloat(med.quantity || 0) * parseFloat(med.price || 0));
                    }, 0);

                    totalCases += Object.entries(dayData.examinations || {})
                        .filter(([price, count]) => count && parseFloat(count) > 0)
                        .reduce((sum, [price, count]) => {
                            return sum + parseInt(count);
                        }, 0);
                    
                    // ƒê·∫øm s·ªë ca 0 ƒë·ªìng
                    zeroCases += parseInt(dayData.examinations?.['0'] || 0);
                });

                return {
                    examTotal,
                    doctorTotal,
                    expenseTotal,
                    medicineTotal,
                    totalCases,
                    zeroCases,
                    netTotal: examTotal - doctorTotal - expenseTotal - medicineTotal
                };
            };

            const monthlyTotals = Object.entries(monthlyGroups).map(([month, data]) => ({
                month,
                ...calculateMonthTotals(data)
            }));

            const yearTotal = monthlyTotals.reduce((acc, month) => ({
                examTotal: acc.examTotal + month.examTotal,
                doctorTotal: acc.doctorTotal + month.doctorTotal,
                expenseTotal: acc.expenseTotal + month.expenseTotal,
                medicineTotal: acc.medicineTotal + month.medicineTotal,
                totalCases: acc.totalCases + month.totalCases,
                zeroCases: acc.zeroCases + month.zeroCases,
                netTotal: acc.netTotal + month.netTotal
            }), { examTotal: 0, doctorTotal: 0, expenseTotal: 0, medicineTotal: 0, totalCases: 0, zeroCases: 0, netTotal: 0 });

            const exportYearlyToExcel = () => {
                const wb = XLSX.utils.book_new();
                
                const data = [
                    ['PH√íNG KH√ÅM B√ÅCH B·∫¢O'],
                    [`B√°o c√°o nƒÉm ${year}`],
                    [`Chi nh√°nh: ${selectedBranch === 'nga-bay' ? 'Ng√£ B·∫£y' : 'Th·ªët N·ªët'}`],
                    [],
                    ['Th√°ng', 'Ti·ªÅn kh√°m (k)', 'S·ªë ca', 'S·ªë ca 0ƒë', 'L∆∞∆°ng BS (k)', 'Chi ph√≠ (k)', 'Ti·ªÅn thu·ªëc (k)', 'C√≤n l·∫°i (k)'],
                ];

                monthlyTotals.forEach(({ month, examTotal, totalCases, zeroCases, doctorTotal, expenseTotal, medicineTotal, netTotal }) => {
                    data.push([
                        `Th√°ng ${parseInt(month)}`,
                        examTotal,
                        totalCases,
                        zeroCases,
                        doctorTotal,
                        expenseTotal,
                        medicineTotal,
                        netTotal
                    ]);
                });

                data.push([]);
                data.push(['T·ªîNG NƒÇM', yearTotal.examTotal, yearTotal.totalCases, yearTotal.zeroCases, yearTotal.doctorTotal, yearTotal.expenseTotal, yearTotal.medicineTotal, yearTotal.netTotal]);

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [
                    { wch: 12 },  // Th√°ng
                    { wch: 15 },  // Ti·ªÅn kh√°m
                    { wch: 10 },  // S·ªë ca
                    { wch: 10 },  // S·ªë ca 0ƒë
                    { wch: 15 },  // L∆∞∆°ng BS
                    { wch: 15 },  // Chi ph√≠
                    { wch: 15 },  // Ti·ªÅn thu·ªëc
                    { wch: 15 }   // C√≤n l·∫°i
                ];

                XLSX.utils.book_append_sheet(wb, ws, `NƒÉm ${year}`);
                XLSX.writeFile(wb, `BaoCaoNam_${selectedBranch}_${year}.xlsx`);
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">
                                    üìÖ B√°o c√°o nƒÉm {year}
                                </h2>
                                <h3 className="text-lg text-gray-600 mt-1">
                                    Chi nh√°nh: {selectedBranch === 'nga-bay' ? 'üè• Ng√£ B·∫£y' : 'üè• Th·ªët N·ªët'}
                                </h3>
                            </div>
                            <button
                                onClick={exportYearlyToExcel}
                                className="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-bold shadow-lg"
                            >
                                üì• Xu·∫•t Excel nƒÉm
                            </button>
                        </div>

                        {/* Yearly Summary */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
                            <div className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border-l-4 border-green-500 shadow">
                                <p className="text-xs text-green-700 font-semibold mb-1">üí∞ Ti·ªÅn kh√°m</p>
                                <p className="text-2xl font-bold text-green-600">{yearTotal.examTotal.toLocaleString()}k</p>
                            </div>
                            <div className="bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 rounded-lg border-l-4 border-indigo-500 shadow">
                                <p className="text-xs text-indigo-700 font-semibold mb-1">üë• S·ªë ca</p>
                                <p className="text-2xl font-bold text-indigo-600">{yearTotal.totalCases.toLocaleString()}</p>
                            </div>
                            <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border-l-4 border-blue-500 shadow">
                                <p className="text-xs text-blue-700 font-semibold mb-1">üë®‚Äç‚öïÔ∏è L∆∞∆°ng BS</p>
                                <p className="text-2xl font-bold text-blue-600">{yearTotal.doctorTotal.toLocaleString()}k</p>
                            </div>
                            <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border-l-4 border-orange-500 shadow">
                                <p className="text-xs text-orange-700 font-semibold mb-1">üí∏ Chi ph√≠</p>
                                <p className="text-2xl font-bold text-orange-600">{yearTotal.expenseTotal.toLocaleString()}k</p>
                            </div>
                            <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border-l-4 border-purple-500 shadow">
                                <p className="text-xs text-purple-700 font-semibold mb-1">üíä Ti·ªÅn thu·ªëc</p>
                                <p className="text-2xl font-bold text-purple-600">{yearTotal.medicineTotal.toLocaleString()}k</p>
                            </div>
                            <div className={`p-4 rounded-lg border-l-4 shadow ${yearTotal.netTotal >= 0 ? 'bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-500' : 'bg-gradient-to-br from-red-50 to-red-100 border-red-500'}`}>
                                <p className={`text-xs font-semibold mb-1 ${yearTotal.netTotal >= 0 ? 'text-emerald-700' : 'text-red-700'}`}>üíµ C√≤n l·∫°i</p>
                                <p className={`text-2xl font-bold ${yearTotal.netTotal >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                    {yearTotal.netTotal.toLocaleString()}k
                                </p>
                            </div>
                        </div>

                        {/* Monthly Table */}
                        <div className="overflow-x-auto">
                            <table className="w-full border-collapse">
                                <thead>
                                    <tr className="bg-gradient-to-r from-gray-700 to-gray-800 text-white">
                                        <th className="border border-gray-600 p-3 text-left">üìÖ Th√°ng</th>
                                        <th className="border border-gray-600 p-3 text-right">üí∞ Ti·ªÅn kh√°m</th>
                                        <th className="border border-gray-600 p-3 text-right">üë• S·ªë ca</th>
                                        <th className="border border-gray-600 p-3 text-right">üë®‚Äç‚öïÔ∏è L∆∞∆°ng BS</th>
                                        <th className="border border-gray-600 p-3 text-right">üí∏ Chi ph√≠</th>
                                        <th className="border border-gray-600 p-3 text-right">üíä Ti·ªÅn thu·ªëc</th>
                                        <th className="border border-gray-600 p-3 text-right">üíµ C√≤n l·∫°i</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {monthlyTotals.map(({ month, examTotal, totalCases, doctorTotal, expenseTotal, medicineTotal, netTotal }) => (
                                        <tr key={month} className="hover:bg-blue-50 transition">
                                            <td className="border border-gray-300 p-3 font-semibold">Th√°ng {parseInt(month)}</td>
                                            <td className="border border-gray-300 p-3 text-right text-green-600 font-bold">
                                                {examTotal.toLocaleString()}k
                                            </td>
                                            <td className="border border-gray-300 p-3 text-right text-indigo-600 font-semibold">
                                                {totalCases}
                                            </td>
                                            <td className="border border-gray-300 p-3 text-right text-blue-600 font-semibold">
                                                {doctorTotal.toLocaleString()}k
                                            </td>
                                            <td className="border border-gray-300 p-3 text-right text-orange-600 font-semibold">
                                                {expenseTotal.toLocaleString()}k
                                            </td>
                                            <td className="border border-gray-300 p-3 text-right text-purple-600 font-semibold">
                                                {medicineTotal.toLocaleString()}k
                                            </td>
                                            <td className={`border border-gray-300 p-3 text-right font-bold ${netTotal >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                                {netTotal.toLocaleString()}k
                                            </td>
                                        </tr>
                                    ))}
                                    <tr className="bg-gray-100 font-bold">
                                        <td className="border border-gray-300 p-3">T·ªîNG NƒÇM</td>
                                        <td className="border border-gray-300 p-3 text-right text-green-600">
                                            {yearTotal.examTotal.toLocaleString()}k
                                        </td>
                                        <td className="border border-gray-300 p-3 text-right text-indigo-600">
                                            {yearTotal.totalCases}
                                        </td>
                                        <td className="border border-gray-300 p-3 text-right text-blue-600">
                                            {yearTotal.doctorTotal.toLocaleString()}k
                                        </td>
                                        <td className="border border-gray-300 p-3 text-right text-orange-600">
                                            {yearTotal.expenseTotal.toLocaleString()}k
                                        </td>
                                        <td className="border border-gray-300 p-3 text-right text-purple-600">
                                            {yearTotal.medicineTotal.toLocaleString()}k
                                        </td>
                                        <td className={`border border-gray-300 p-3 text-right ${yearTotal.netTotal >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                            {yearTotal.netTotal.toLocaleString()}k
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        // Medicine Management Component
        function MedicineManagement({ medicineList, setMedicineList }) {
            const [newMedicine, setNewMedicine] = useState('');
            const [newPrice, setNewPrice] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [editingIndex, setEditingIndex] = useState(null);

            const addMedicine = async () => {
                if (!newMedicine.trim()) {
                    alert('Vui l√≤ng nh·∫≠p t√™n thu·ªëc!');
                    return;
                }
                
                if (!newPrice || parseFloat(newPrice) <= 0) {
                    alert('Vui l√≤ng nh·∫≠p gi√° h·ª£p l·ªá!');
                    return;
                }

                const medicineName = newMedicine.trim();
                if (medicineList.some(m => m.name.toLowerCase() === medicineName.toLowerCase())) {
                    alert('Thu·ªëc n√†y ƒë√£ c√≥ trong danh s√°ch!');
                    return;
                }

                try {
                    const updatedList = [...medicineList, { name: medicineName, price: parseFloat(newPrice) }]
                        .sort((a, b) => a.name.localeCompare(b.name));
                    await db.ref('settings_v2/medicineList').set(updatedList);
                    setMedicineList(updatedList);
                    setNewMedicine('');
                    setNewPrice('');
                    alert('‚úÖ ƒê√£ th√™m thu·ªëc th√†nh c√¥ng!');
                } catch (error) {
                    alert('‚ùå L·ªói: ' + error.message);
                }
            };

            const removeMedicine = async (index) => {
                const medicine = filteredMedicines[index];
                if (!confirm(`X√≥a thu·ªëc "${medicine.name}" kh·ªèi danh s√°ch?`)) {
                    return;
                }

                try {
                    const updatedList = medicineList.filter(m => m.name !== medicine.name);
                    await db.ref('settings_v2/medicineList').set(updatedList);
                    setMedicineList(updatedList);
                    alert('‚úÖ ƒê√£ x√≥a thu·ªëc th√†nh c√¥ng!');
                } catch (error) {
                    alert('‚ùå L·ªói: ' + error.message);
                }
            };

            const updatePrice = async (medicine, newPriceValue) => {
                if (!newPriceValue || parseFloat(newPriceValue) <= 0) {
                    alert('Vui l√≤ng nh·∫≠p gi√° h·ª£p l·ªá!');
                    return;
                }

                try {
                    const updatedList = medicineList.map(m => 
                        m.name === medicine.name 
                            ? { ...m, price: parseFloat(newPriceValue) }
                            : m
                    );
                    await db.ref('settings_v2/medicineList').set(updatedList);
                    setMedicineList(updatedList);
                    setEditingIndex(null);
                    alert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t gi√° th√†nh c√¥ng!');
                } catch (error) {
                    alert('‚ùå L·ªói: ' + error.message);
                }
            };

            const filteredMedicines = medicineList.filter(med => 
                med.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">‚öôÔ∏è Qu·∫£n l√Ω danh s√°ch thu·ªëc</h2>
                        <p className="text-gray-600 mb-6">
                            Danh s√°ch thu·ªëc th∆∞·ªùng d√πng v·ªõi gi√° m·∫∑c ƒë·ªãnh. D√πng cho ph·∫ßn "Th√™m t·ª´ danh s√°ch" khi t√≠nh ti·ªÅn thu·ªëc th√°ng.
                        </p>

                        {/* Add Medicine */}
                        <div className="flex gap-3 mb-6">
                            <input
                                type="text"
                                value={newMedicine}
                                onChange={(e) => setNewMedicine(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && newPrice && addMedicine()}
                                placeholder="T√™n thu·ªëc m·ªõi..."
                                className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                            <input
                                type="number"
                                value={newPrice}
                                onChange={(e) => setNewPrice(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && newMedicine && addMedicine()}
                                placeholder="Gi√° (k)"
                                className="w-32 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                            <button
                                onClick={addMedicine}
                                className="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-bold"
                            >
                                ‚ûï Th√™m thu·ªëc
                            </button>
                        </div>

                        {/* Search */}
                        <div className="mb-4">
                            <input
                                type="text"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                placeholder="üîç T√¨m ki·∫øm thu·ªëc..."
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                        </div>

                        {/* Medicine List */}
                        <div className="bg-gray-50 rounded-lg p-4">
                            <div className="flex justify-between items-center mb-3">
                                <p className="font-semibold text-gray-700">
                                    T·ªïng s·ªë: {filteredMedicines.length} thu·ªëc
                                </p>
                            </div>
                            <div className="space-y-2 max-h-96 overflow-y-auto">
                                {filteredMedicines.length === 0 && (
                                    <p className="text-gray-400 text-center py-8">
                                        Kh√¥ng t√¨m th·∫•y thu·ªëc n√†o
                                    </p>
                                )}
                                {filteredMedicines.map((medicine, index) => (
                                    <div 
                                        key={index}
                                        className="flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200 hover:border-blue-300 transition"
                                    >
                                        <div className="flex-1">
                                            <span className="text-gray-800 font-medium capitalize">
                                                {medicine.name}
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            {editingIndex === index ? (
                                                <>
                                                    <input
                                                        type="number"
                                                        defaultValue={medicine.price}
                                                        onKeyPress={(e) => {
                                                            if (e.key === 'Enter') {
                                                                updatePrice(medicine, e.target.value);
                                                            }
                                                        }}
                                                        className="w-24 px-3 py-1 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                        autoFocus
                                                        onBlur={(e) => {
                                                            if (e.target.value !== medicine.price.toString()) {
                                                                updatePrice(medicine, e.target.value);
                                                            } else {
                                                                setEditingIndex(null);
                                                            }
                                                        }}
                                                    />
                                                    <span className="text-green-600 font-semibold">k</span>
                                                </>
                                            ) : (
                                                <>
                                                    <span className="text-green-600 font-bold w-20 text-right">
                                                        {medicine.price}k
                                                    </span>
                                                    <button
                                                        onClick={() => setEditingIndex(index)}
                                                        className="text-blue-500 hover:text-blue-700 font-semibold text-sm"
                                                        title="S·ª≠a gi√°"
                                                    >
                                                        ‚úèÔ∏è
                                                    </button>
                                                </>
                                            )}
                                            <button
                                                onClick={() => removeMedicine(index)}
                                                className="text-red-500 hover:text-red-700 font-bold text-lg"
                                                title="X√≥a thu·ªëc n√†y"
                                            >
                                                ‚úï
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Examination Section with Add Custom Price
        function ExaminationSection({ examinations, onChange, readOnly = false, customPrices = [], saveCustomPrices }) {
            const [priceLevels, setPriceLevels] = useState([]);
            const [newPrice, setNewPrice] = useState('');

            // Rebuild price levels when examinations or customPrices change
            useEffect(() => {
                const existingPrices = Object.keys(examinations).map(p => parseFloat(p));
                const allPrices = [...new Set([...DEFAULT_PRICE_LEVELS, ...customPrices, ...existingPrices])];
                setPriceLevels(allPrices.sort((a, b) => a - b));
            }, [examinations, customPrices]);

            const addCustomPrice = () => {
                const price = parseFloat(newPrice);
                if (price && price > 0 && !customPrices.includes(price) && !DEFAULT_PRICE_LEVELS.includes(price)) {
                    const updated = [...customPrices, price].sort((a, b) => a - b);
                    saveCustomPrices(updated);
                    setNewPrice('');
                }
            };

            const removePrice = (price) => {
                if (confirm(`X√≥a m·ª©c gi√° ${price}k?`)) {
                    // Remove from custom prices
                    const updatedCustom = customPrices.filter(p => p !== price);
                    saveCustomPrices(updatedCustom);
                    
                    // Remove from examinations
                    const updated = {...examinations};
                    delete updated[price];
                    onChange(updated);
                }
            };

            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">üí∞ Ti·ªÅn kh√°m b·ªánh</h2>
                        {!readOnly && (
                            <div className="flex gap-2">
                                <input
                                    type="number"
                                    value={newPrice}
                                    onChange={(e) => setNewPrice(e.target.value)}
                                    placeholder="Gi√° m·ªõi (k)"
                                    className="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    onKeyPress={(e) => e.key === 'Enter' && addCustomPrice()}
                                />
                                <button
                                    onClick={addCustomPrice}
                                    className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition font-semibold"
                                >
                                    ‚ûï Th√™m gi√°
                                </button>
                            </div>
                        )}
                    </div>
                    
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        {priceLevels.map(price => (
                            <div key={price} className="relative">
                                <div className="flex flex-col gap-1">
                                    <div className="flex justify-between items-center">
                                        <label className="text-xs font-semibold text-gray-600">
                                            {price}k
                                        </label>
                                        {!DEFAULT_PRICE_LEVELS.includes(price) && customPrices.includes(price) && !readOnly && (
                                            <button
                                                onClick={() => removePrice(price)}
                                                className="text-red-500 hover:text-red-700 text-xs"
                                                title="X√≥a m·ª©c gi√° n√†y"
                                            >
                                                ‚úï
                                            </button>
                                        )}
                                    </div>
                                    <input
                                        type="number"
                                        min="0"
                                        value={examinations?.[price] || ''}
                                        onChange={(e) => {
                                            onChange({
                                                ...examinations,
                                                [price]: e.target.value
                                            });
                                        }}
                                        disabled={readOnly}
                                        className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg font-semibold ${readOnly ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                                        placeholder="0"
                                    />
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                        <div className="flex justify-between items-center mb-2">
                            <p className="text-lg font-bold text-blue-800">
                                T·ªïng ti·ªÅn kh√°m: {Object.entries(examinations || {})
                                    .filter(([price, count]) => count && parseFloat(count) > 0)
                                    .reduce((sum, [price, count]) => {
                                        return sum + (parseFloat(price) * parseFloat(count));
                                    }, 0).toLocaleString()}k
                            </p>
                        </div>
                        <div className="flex justify-between items-center">
                            <p className="text-sm font-semibold text-blue-700">
                                T·ªïng s·ªë ca:
                            </p>
                            <p className="text-lg font-bold text-blue-600">
                                {Object.entries(examinations || {})
                                    .filter(([price, count]) => count && parseFloat(count) > 0)
                                    .reduce((sum, [price, count]) => {
                                        return sum + parseInt(count);
                                    }, 0)} ca
                            </p>
                        </div>
                        {/* Debug: Chi ti·∫øt t√≠nh to√°n */}
                        <details className="mt-3">
                            <summary className="text-xs text-blue-600 cursor-pointer hover:text-blue-800">
                                üîç Xem chi ti·∫øt t√≠nh to√°n
                            </summary>
                            <div className="mt-2 text-xs bg-white p-2 rounded border border-blue-200 max-h-40 overflow-y-auto">
                                {Object.entries(examinations || {})
                                    .filter(([price, count]) => count && parseFloat(count) > 0)
                                    .sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]))
                                    .map(([price, count]) => (
                                        <div key={price} className="flex justify-between py-1 border-b border-gray-100">
                                            <span>{price}k √ó {count} ca</span>
                                            <span className="font-semibold text-green-600">
                                                = {(parseFloat(price) * parseFloat(count)).toLocaleString()}k
                                            </span>
                                        </div>
                                    ))
                                }
                                <div className="flex justify-between py-2 mt-2 border-t-2 border-blue-300 font-bold">
                                    <span>T·ªîNG</span>
                                    <span className="text-blue-700">
                                        = {Object.entries(examinations || {})
                                            .filter(([price, count]) => count && parseFloat(count) > 0)
                                            .reduce((sum, [price, count]) => {
                                                return sum + (parseFloat(price) * parseFloat(count));
                                            }, 0).toLocaleString()}k
                                    </span>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            );
        }

        // Doctor Fees Component
        function DoctorFeesSection({ doctorFees, onChange, readOnly = false }) {
            const addDoctorFee = () => {
                onChange([...doctorFees, { doctor: '', amount: '' }]);
            };

            const removeDoctorFee = (index) => {
                onChange(doctorFees.filter((_, i) => i !== index));
            };

            const updateDoctorFee = (index, field, value) => {
                const updated = [...doctorFees];
                updated[index][field] = value;
                onChange(updated);
            };

            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">üë®‚Äç‚öïÔ∏è L∆∞∆°ng b√°c sƒ©</h2>
                        {!readOnly && (
                            <button
                                onClick={addDoctorFee}
                                className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition font-semibold"
                            >
                                ‚ûï Th√™m BS
                            </button>
                        )}
                    </div>
                    <div className="space-y-3">
                        {doctorFees.length === 0 && (
                            <p className="text-gray-400 text-center py-4">Ch∆∞a c√≥ l∆∞∆°ng b√°c sƒ© n√†o</p>
                        )}
                        {doctorFees.map((fee, index) => (
                            <div key={index} className="flex gap-3 items-center bg-gray-50 p-3 rounded-lg">
                                <input
                                    type="text"
                                    value={fee.doctor}
                                    onChange={(e) => updateDoctorFee(index, 'doctor', e.target.value)}
                                    placeholder="BS Kh√°nh, BS Trung..."
                                    disabled={readOnly}
                                    className={`flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${readOnly ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                                />
                                <input
                                    type="number"
                                    value={fee.amount}
                                    onChange={(e) => updateDoctorFee(index, 'amount', e.target.value)}
                                    placeholder="500"
                                    disabled={readOnly}
                                    className={`w-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${readOnly ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                                />
                                <span className="text-gray-600 font-semibold">k</span>
                                {!readOnly && (
                                    <button
                                        onClick={() => removeDoctorFee(index)}
                                        className="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition font-bold"
                                    >
                                        ‚úï
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Expenses Component
        function ExpensesSection({ expenses, onChange, readOnly = false }) {
            const addExpense = () => {
                onChange([...expenses, { description: '', amount: '' }]);
            };

            const removeExpense = (index) => {
                onChange(expenses.filter((_, i) => i !== index));
            };

            const updateExpense = (index, field, value) => {
                const updated = [...expenses];
                updated[index][field] = value;
                onChange(updated);
            };

            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">üí∏ Ti·ªÅn chi</h2>
                        {!readOnly && (
                            <button
                                onClick={addExpense}
                                className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition font-semibold"
                            >
                                ‚ûï Th√™m chi ph√≠
                            </button>
                        )}
                    </div>
                    <div className="space-y-3">
                        {expenses.length === 0 && (
                            <p className="text-gray-400 text-center py-4">Ch∆∞a c√≥ chi ph√≠ n√†o</p>
                        )}
                        {expenses.map((expense, index) => (
                            <div key={index} className="flex gap-3 items-center bg-gray-50 p-3 rounded-lg">
                                <input
                                    type="text"
                                    value={expense.description}
                                    onChange={(e) => updateExpense(index, 'description', e.target.value)}
                                    placeholder="Ti·ªÅn ƒëi·ªán, n∆∞·ªõc, l∆∞∆°ng..."
                                    disabled={readOnly}
                                    className={`flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${readOnly ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                                />
                                <input
                                    type="number"
                                    value={expense.amount}
                                    onChange={(e) => updateExpense(index, 'amount', e.target.value)}
                                    placeholder="200"
                                    disabled={readOnly}
                                    className={`w-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ${readOnly ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                                />
                                <span className="text-gray-600 font-semibold">k</span>
                                {!readOnly && (
                                    <button
                                        onClick={() => removeExpense(index)}
                                        className="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition font-bold"
                                    >
                                        ‚úï
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Medicine Section Component
        function MedicineSection({ medicines, medicineList, onChange, readOnly = false }) {
            const [showSuggestions, setShowSuggestions] = useState({});
            const [showMedicineSelect, setShowMedicineSelect] = useState(false);

            const addMedicine = () => {
                onChange([...medicines, { name: '', quantity: '', price: '' }]);
            };

            const addFromList = (medicine) => {
                const existing = medicines.find(m => m.name.toLowerCase() === medicine.name.toLowerCase());
                if (existing) {
                    alert('Thu·ªëc n√†y ƒë√£ c√≥ trong danh s√°ch!');
                    return;
                }
                onChange([...medicines, { name: medicine.name, quantity: '', price: medicine.price }]);
                setShowMedicineSelect(false);
            };

            const removeMedicine = (index) => {
                onChange(medicines.filter((_, i) => i !== index));
            };

            const updateMedicine = (index, field, value) => {
                const updated = [...medicines];
                updated[index][field] = value;
                
                // Auto-fill price when selecting from suggestions
                if (field === 'name') {
                    const matchedMedicine = medicineList.find(m => m.name.toLowerCase() === value.toLowerCase());
                    if (matchedMedicine && !updated[index].price) {
                        updated[index].price = matchedMedicine.price;
                    }
                }
                
                onChange(updated);
            };

            const selectMedicine = (index, medicine) => {
                const updated = [...medicines];
                updated[index].name = medicine.name;
                updated[index].price = medicine.price;
                onChange(updated);
                setShowSuggestions({ ...showSuggestions, [index]: false });
            };

            const getSuggestions = (index, searchTerm) => {
                if (!searchTerm || searchTerm.length < 2) return [];
                return medicineList.filter(med => 
                    med.name.toLowerCase().includes(searchTerm.toLowerCase())
                ).slice(0, 10);
            };

            const totalMedicine = medicines.reduce((sum, med) => {
                return sum + (parseFloat(med.quantity || 0) * parseFloat(med.price || 0));
            }, 0);

            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">üíä Ti·ªÅn thu·ªëc</h2>
                        {!readOnly && (
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setShowMedicineSelect(!showMedicineSelect)}
                                    className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition font-semibold"
                                >
                                    üìö Ch·ªçn t·ª´ danh s√°ch
                                </button>
                                <button
                                    onClick={addMedicine}
                                    className="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition font-semibold"
                                >
                                    ‚ûï Th√™m thu·ªëc
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Medicine Select Popup */}
                    {showMedicineSelect && !readOnly && (
                        <div className="mb-4 bg-green-50 border-2 border-green-300 rounded-lg p-4">
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="font-bold text-gray-800">Ch·ªçn thu·ªëc t·ª´ danh s√°ch:</h3>
                                <button
                                    onClick={() => setShowMedicineSelect(false)}
                                    className="text-red-500 hover:text-red-700 font-bold text-xl"
                                >
                                    ‚úï
                                </button>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-60 overflow-y-auto">
                                {medicineList.map((med, i) => (
                                    <button
                                        key={i}
                                        onClick={() => addFromList(med)}
                                        className="text-left px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-green-100 hover:border-green-500 transition text-sm"
                                    >
                                        <div className="font-semibold capitalize">{med.name}</div>
                                        <div className="text-xs text-green-600 font-bold">{med.price}k</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="space-y-3">
                        {medicines.length === 0 && (
                            <p className="text-gray-400 text-center py-4">Ch∆∞a c√≥ thu·ªëc n√†o</p>
                        )}
                        {medicines.map((medicine, index) => {
                            const suggestions = showSuggestions[index] ? getSuggestions(index, medicine.name) : [];
                            const total = (parseFloat(medicine.quantity || 0) * parseFloat(medicine.price || 0));
                            
                            return (
                                <div key={index} className="bg-gray-50 p-3 rounded-lg">
                                    <div className="flex gap-3 items-start">
                                        <div className="flex-1 relative">
                                            <input
                                                type="text"
                                                value={medicine.name}
                                                onChange={(e) => {
                                                    updateMedicine(index, 'name', e.target.value);
                                                    setShowSuggestions({ ...showSuggestions, [index]: true });
                                                }}
                                                onFocus={() => setShowSuggestions({ ...showSuggestions, [index]: true })}
                                                onBlur={() => setTimeout(() => setShowSuggestions({ ...showSuggestions, [index]: false }), 200)}
                                                placeholder="T√™n thu·ªëc..."
                                                disabled={readOnly}
                                                className={`w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 capitalize ${readOnly ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                                            />
                                            {suggestions.length > 0 && !readOnly && (
                                                <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                    {suggestions.map((suggestion, i) => (
                                                        <div
                                                            key={i}
                                                            onClick={() => selectMedicine(index, suggestion)}
                                                            className="px-4 py-2 hover:bg-purple-50 cursor-pointer"
                                                        >
                                                            <div className="font-semibold capitalize text-sm">{suggestion.name}</div>
                                                            <div className="text-xs text-green-600 font-bold">{suggestion.price}k</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        <input
                                            type="number"
                                            value={medicine.quantity}
                                            onChange={(e) => updateMedicine(index, 'quantity', e.target.value)}
                                            placeholder="SL"
                                            disabled={readOnly}
                                            className={`w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-center ${readOnly ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                                        />
                                        <input
                                            type="number"
                                            value={medicine.price}
                                            onChange={(e) => updateMedicine(index, 'price', e.target.value)}
                                            placeholder="Gi√°"
                                            disabled={readOnly}
                                            className={`w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 ${readOnly ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                                        />
                                        <div className="w-28 px-3 py-2 bg-purple-50 border border-purple-200 rounded-lg text-center font-semibold text-purple-700">
                                            {total.toLocaleString()}k
                                        </div>
                                        {!readOnly && (
                                            <button
                                                onClick={() => removeMedicine(index)}
                                                className="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition font-bold"
                                            >
                                                ‚úï
                                            </button>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                        {medicines.length > 0 && (
                            <div className="mt-4 p-4 bg-purple-50 rounded-lg border-2 border-purple-300">
                                <p className="text-lg font-bold text-purple-800">
                                    T·ªïng ti·ªÅn thu·ªëc: {totalMedicine.toLocaleString()}k
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Report View Component
        function ReportView({ selectedBranch, selectedDate, monthlyData }) {
            const calculateDayTotals = (dayData) => {
                const examTotal = Object.entries(dayData.examinations || {})
                    .filter(([price, count]) => count && parseFloat(count) > 0)
                    .reduce((sum, [price, count]) => {
                        return sum + (parseFloat(price) * parseFloat(count));
                    }, 0);

                const expenseTotal = (dayData.expenses || []).reduce((sum, exp) => {
                    return sum + parseFloat(exp.amount || 0);
                }, 0);

                const doctorTotal = (dayData.doctorFees || []).reduce((sum, fee) => {
                    return sum + parseFloat(fee.amount || 0);
                }, 0);

                const medicineTotal = (dayData.medicines || []).reduce((sum, med) => {
                    return sum + (parseFloat(med.quantity || 0) * parseFloat(med.price || 0));
                }, 0);

                return {
                    examTotal,
                    expenseTotal,
                    doctorTotal,
                    medicineTotal,
                    netTotal: examTotal - expenseTotal - doctorTotal - medicineTotal
                };
            };

            const monthlyTotals = Object.values(monthlyData).reduce((acc, day) => {
                const totals = calculateDayTotals(day);
                return {
                    examTotal: acc.examTotal + totals.examTotal,
                    expenseTotal: acc.expenseTotal + totals.expenseTotal,
                    doctorTotal: acc.doctorTotal + totals.doctorTotal,
                    medicineTotal: acc.medicineTotal + totals.medicineTotal,
                    netTotal: acc.netTotal + totals.netTotal
                };
            }, { examTotal: 0, expenseTotal: 0, doctorTotal: 0, medicineTotal: 0, netTotal: 0 });

            const sortedDays = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));

            const exportToExcel = () => {
                const wb = XLSX.utils.book_new();
                
                // Sheet 1: T·ªïng h·ª£p
                const summaryData = [
                    ['PH√íNG KH√ÅM B√ÅCH B·∫¢O'],
                    [`B√°o c√°o th√°ng ${selectedDate.substring(5, 7)}/${selectedDate.substring(0, 4)}`],
                    [`Chi nh√°nh: ${selectedBranch === 'nga-bay' ? 'Ng√£ B·∫£y' : 'Th·ªët N·ªët'}`],
                    [],
                    ['Ng√†y', 'Ti·ªÅn kh√°m (k)', 'S·ªë ca', 'S·ªë ca 0ƒë', 'L∆∞∆°ng BS (k)', 'Chi ph√≠ (k)', 'Ti·ªÅn thu·ªëc (k)', 'C√≤n l·∫°i (k)'],
                ];

                sortedDays.forEach(([dateKey, dayData]) => {
                    const totals = calculateDayTotals(dayData);
                    const totalCases = Object.entries(dayData.examinations || {}).reduce((sum, [price, count]) => {
                        return sum + parseInt(count || 0);
                    }, 0);
                    
                    // ƒê·∫øm s·ªë ca 0 ƒë·ªìng
                    const zeroCases = parseInt(dayData.examinations?.['0'] || 0);
                    
                    summaryData.push([
                        dayData.date,
                        totals.examTotal,
                        totalCases,
                        zeroCases,
                        totals.doctorTotal,
                        totals.expenseTotal,
                        totals.medicineTotal,
                        totals.netTotal
                    ]);
                });

                summaryData.push([]);
                
                const totalCasesMonth = sortedDays.reduce((sum, [dateKey, dayData]) => {
                    return sum + Object.entries(dayData.examinations || {}).reduce((s, [price, count]) => {
                        return s + parseInt(count || 0);
                    }, 0);
                }, 0);
                
                // T·ªïng s·ªë ca 0 ƒë·ªìng c·∫£ th√°ng
                const totalZeroCasesMonth = sortedDays.reduce((sum, [dateKey, dayData]) => {
                    return sum + parseInt(dayData.examinations?.['0'] || 0);
                }, 0);
                
                summaryData.push(['T·ªîNG', monthlyTotals.examTotal, totalCasesMonth, totalZeroCasesMonth, monthlyTotals.doctorTotal, monthlyTotals.expenseTotal, monthlyTotals.medicineTotal, monthlyTotals.netTotal]);

                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                wsSummary['!cols'] = [
                    { wch: 12 },  // Ng√†y
                    { wch: 15 },  // Ti·ªÅn kh√°m
                    { wch: 10 },  // S·ªë ca
                    { wch: 10 },  // S·ªë ca 0ƒë
                    { wch: 15 },  // L∆∞∆°ng BS
                    { wch: 15 },  // Chi ph√≠
                    { wch: 15 },  // Ti·ªÅn thu·ªëc
                    { wch: 15 }   // C√≤n l·∫°i
                ];
                XLSX.utils.book_append_sheet(wb, wsSummary, 'T·ªïng h·ª£p');

                // Sheet 2: Chi ti·∫øt ti·ªÅn thu·ªëc
                const medicineData = [
                    ['PH√íNG KH√ÅM B√ÅCH B·∫¢O'],
                    [`Chi ti·∫øt ti·ªÅn thu·ªëc th√°ng ${selectedDate.substring(5, 7)}/${selectedDate.substring(0, 4)}`],
                    [`Chi nh√°nh: ${selectedBranch === 'nga-bay' ? 'Ng√£ B·∫£y' : 'Th·ªët N·ªët'}`],
                    [],
                    ['Ng√†y', 'T√™n thu·ªëc', 'S·ªë l∆∞·ª£ng', 'Gi√° (k)', 'Th√†nh ti·ªÅn (k)'],
                ];

                sortedDays.forEach(([dateKey, dayData]) => {
                    if (dayData.medicines && dayData.medicines.length > 0) {
                        dayData.medicines.forEach((med, index) => {
                            const total = parseFloat(med.quantity || 0) * parseFloat(med.price || 0);
                            medicineData.push([
                                index === 0 ? dayData.date : '',
                                med.name,
                                med.quantity,
                                med.price,
                                total
                            ]);
                        });
                        // T·ªïng ng√†y
                        const dayMedicineTotal = dayData.medicines.reduce((sum, med) => {
                            return sum + (parseFloat(med.quantity || 0) * parseFloat(med.price || 0));
                        }, 0);
                        medicineData.push([
                            '',
                            `T·ªïng ${dayData.date}`,
                            '',
                            '',
                            dayMedicineTotal
                        ]);
                        medicineData.push([]);
                    }
                });

                medicineData.push([]);
                medicineData.push(['', 'T·ªîNG TI·ªÄN THU·ªêC TH√ÅNG', '', '', monthlyTotals.medicineTotal]);

                const wsMedicine = XLSX.utils.aoa_to_sheet(medicineData);
                wsMedicine['!cols'] = [
                    { wch: 12 },
                    { wch: 30 },
                    { wch: 12 },
                    { wch: 12 },
                    { wch: 15 }
                ];
                XLSX.utils.book_append_sheet(wb, wsMedicine, 'Chi ti·∫øt thu·ªëc');

                // Sheet 3: Chi ti·∫øt ti·ªÅn kh√°m
                const examData = [
                    ['PH√íNG KH√ÅM B√ÅCH B·∫¢O'],
                    [`Chi ti·∫øt ti·ªÅn kh√°m th√°ng ${selectedDate.substring(5, 7)}/${selectedDate.substring(0, 4)}`],
                    [`Chi nh√°nh: ${selectedBranch === 'nga-bay' ? 'Ng√£ B·∫£y' : 'Th·ªët N·ªët'}`],
                    [],
                    ['Ng√†y', 'Gi√° kh√°m (k)', 'S·ªë ca', 'Th√†nh ti·ªÅn (k)'],
                ];

                sortedDays.forEach(([dateKey, dayData]) => {
                    if (dayData.examinations && Object.keys(dayData.examinations).length > 0) {
                        const sortedExams = Object.entries(dayData.examinations)
                            .filter(([price, count]) => count && count > 0)
                            .sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]));
                        
                        sortedExams.forEach(([price, count], index) => {
                            const total = parseFloat(price) * parseFloat(count);
                            examData.push([
                                index === 0 ? dayData.date : '',
                                price,
                                count,
                                total
                            ]);
                        });
                        
                        const dayExamTotal = Object.entries(dayData.examinations).reduce((sum, [price, count]) => {
                            return sum + (parseFloat(price) * parseFloat(count || 0));
                        }, 0);
                        const dayTotalCases = Object.entries(dayData.examinations).reduce((sum, [price, count]) => {
                            return sum + parseInt(count || 0);
                        }, 0);
                        
                        examData.push([
                            '',
                            `T·ªïng ${dayData.date}`,
                            dayTotalCases,
                            dayExamTotal
                        ]);
                        examData.push([]);
                    }
                });

                examData.push([]);
                examData.push(['', 'T·ªîNG TH√ÅNG', totalCasesMonth, monthlyTotals.examTotal]);

                const wsExam = XLSX.utils.aoa_to_sheet(examData);
                wsExam['!cols'] = [
                    { wch: 12 },
                    { wch: 15 },
                    { wch: 12 },
                    { wch: 15 }
                ];
                XLSX.utils.book_append_sheet(wb, wsExam, 'Chi ti·∫øt kh√°m');

                // Sheet 4: Chi ti·∫øt l∆∞∆°ng b√°c sƒ©
                const doctorData = [
                    ['PH√íNG KH√ÅM B√ÅCH B·∫¢O'],
                    [`Chi ti·∫øt l∆∞∆°ng b√°c sƒ© th√°ng ${selectedDate.substring(5, 7)}/${selectedDate.substring(0, 4)}`],
                    [`Chi nh√°nh: ${selectedBranch === 'nga-bay' ? 'Ng√£ B·∫£y' : 'Th·ªët N·ªët'}`],
                    [],
                    ['Ng√†y', 'T√™n b√°c sƒ©', 'L∆∞∆°ng (k)'],
                ];

                sortedDays.forEach(([dateKey, dayData]) => {
                    if (dayData.doctorFees && dayData.doctorFees.length > 0) {
                        dayData.doctorFees.forEach((doc, index) => {
                            doctorData.push([
                                index === 0 ? dayData.date : '',
                                doc.doctor,
                                doc.amount
                            ]);
                        });
                        const dayDoctorTotal = dayData.doctorFees.reduce((sum, doc) => {
                            return sum + parseFloat(doc.amount || 0);
                        }, 0);
                        doctorData.push([
                            '',
                            `T·ªïng ${dayData.date}`,
                            dayDoctorTotal
                        ]);
                        doctorData.push([]);
                    }
                });

                doctorData.push([]);
                doctorData.push(['', 'T·ªîNG L∆Ø∆†NG TH√ÅNG', monthlyTotals.doctorTotal]);

                const wsDoctor = XLSX.utils.aoa_to_sheet(doctorData);
                wsDoctor['!cols'] = [
                    { wch: 12 },
                    { wch: 25 },
                    { wch: 15 }
                ];
                XLSX.utils.book_append_sheet(wb, wsDoctor, 'Chi ti·∫øt l∆∞∆°ng BS');

                // Sheet 5: Chi ti·∫øt chi ph√≠
                const expenseData = [
                    ['PH√íNG KH√ÅM B√ÅCH B·∫¢O'],
                    [`Chi ti·∫øt chi ph√≠ th√°ng ${selectedDate.substring(5, 7)}/${selectedDate.substring(0, 4)}`],
                    [`Chi nh√°nh: ${selectedBranch === 'nga-bay' ? 'Ng√£ B·∫£y' : 'Th·ªët N·ªët'}`],
                    [],
                    ['Ng√†y', 'M√¥ t·∫£', 'S·ªë ti·ªÅn (k)'],
                ];

                sortedDays.forEach(([dateKey, dayData]) => {
                    if (dayData.expenses && dayData.expenses.length > 0) {
                        dayData.expenses.forEach((exp, index) => {
                            expenseData.push([
                                index === 0 ? dayData.date : '',
                                exp.description,
                                exp.amount
                            ]);
                        });
                        const dayExpenseTotal = dayData.expenses.reduce((sum, exp) => {
                            return sum + parseFloat(exp.amount || 0);
                        }, 0);
                        expenseData.push([
                            '',
                            `T·ªïng ${dayData.date}`,
                            dayExpenseTotal
                        ]);
                        expenseData.push([]);
                    }
                });

                expenseData.push([]);
                expenseData.push(['', 'T·ªîNG CHI PH√ç TH√ÅNG', monthlyTotals.expenseTotal]);

                const wsExpense = XLSX.utils.aoa_to_sheet(expenseData);
                wsExpense['!cols'] = [
                    { wch: 12 },
                    { wch: 35 },
                    { wch: 15 }
                ];
                XLSX.utils.book_append_sheet(wb, wsExpense, 'Chi ti·∫øt chi ph√≠');
                
                const filename = `BaoCao_${selectedBranch}_${selectedDate.substring(0, 7)}.xlsx`;
                XLSX.writeFile(wb, filename);
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <div className="flex justify-between items-center mb-4">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">
                                    üìä B√°o c√°o th√°ng {selectedDate.substring(5, 7)}/{selectedDate.substring(0, 4)}
                                </h2>
                                <h3 className="text-lg text-gray-600 mt-1">
                                    Chi nh√°nh: {selectedBranch === 'nga-bay' ? 'üè• Ng√£ B·∫£y' : 'üè• Th·ªët N·ªët'}
                                </h3>
                            </div>
                            <button
                                onClick={exportToExcel}
                                className="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-bold shadow-lg flex items-center gap-2"
                            >
                                üì• Xu·∫•t Excel
                            </button>
                        </div>

                        {/* Monthly Summary */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                            <div className="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg border-l-4 border-green-500 shadow">
                                <p className="text-sm text-green-700 font-semibold mb-1">üí∞ T·ªïng ti·ªÅn kh√°m</p>
                                <p className="text-3xl font-bold text-green-600">{monthlyTotals.examTotal.toLocaleString()}k</p>
                            </div>
                            <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg border-l-4 border-blue-500 shadow">
                                <p className="text-sm text-blue-700 font-semibold mb-1">üë®‚Äç‚öïÔ∏è L∆∞∆°ng b√°c sƒ©</p>
                                <p className="text-3xl font-bold text-blue-600">{monthlyTotals.doctorTotal.toLocaleString()}k</p>
                            </div>
                            <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-lg border-l-4 border-orange-500 shadow">
                                <p className="text-sm text-orange-700 font-semibold mb-1">üí∏ Chi ph√≠</p>
                                <p className="text-3xl font-bold text-orange-600">{monthlyTotals.expenseTotal.toLocaleString()}k</p>
                            </div>
                            <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-lg border-l-4 border-purple-500 shadow">
                                <p className="text-sm text-purple-700 font-semibold mb-1">üíä Ti·ªÅn thu·ªëc</p>
                                <p className="text-3xl font-bold text-purple-600">{monthlyTotals.medicineTotal.toLocaleString()}k</p>
                            </div>
                            <div className={`p-6 rounded-lg border-l-4 shadow ${monthlyTotals.netTotal >= 0 ? 'bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-500' : 'bg-gradient-to-br from-red-50 to-red-100 border-red-500'}`}>
                                <p className={`text-sm font-semibold mb-1 ${monthlyTotals.netTotal >= 0 ? 'text-emerald-700' : 'text-red-700'}`}>üíµ C√≤n l·∫°i</p>
                                <p className={`text-3xl font-bold ${monthlyTotals.netTotal >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                    {monthlyTotals.netTotal.toLocaleString()}k
                                </p>
                            </div>
                        </div>

                        {/* Daily Details Table */}
                        <div className="overflow-x-auto">
                            <table className="w-full border-collapse">
                                <thead>
                                    <tr className="bg-gradient-to-r from-gray-700 to-gray-800 text-white">
                                        <th className="border border-gray-600 p-3 text-left">üìÖ Ng√†y</th>
                                        <th className="border border-gray-600 p-3 text-right">üí∞ Ti·ªÅn kh√°m</th>
                                        <th className="border border-gray-600 p-3 text-right">üë®‚Äç‚öïÔ∏è L∆∞∆°ng BS</th>
                                        <th className="border border-gray-600 p-3 text-right">üí∏ Chi ph√≠</th>
                                        <th className="border border-gray-600 p-3 text-right">üíä Ti·ªÅn thu·ªëc</th>
                                        <th className="border border-gray-600 p-3 text-right">üíµ C√≤n l·∫°i</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedDays.length === 0 && (
                                        <tr>
                                            <td colSpan="6" className="border p-6 text-center text-gray-400">
                                                Ch∆∞a c√≥ d·ªØ li·ªáu trong th√°ng n√†y
                                            </td>
                                        </tr>
                                    )}
                                    {sortedDays.map(([dateKey, dayData]) => {
                                        const totals = calculateDayTotals(dayData);
                                        return (
                                            <tr key={dateKey} className="hover:bg-blue-50 transition">
                                                <td className="border border-gray-300 p-3 font-semibold">{dayData.date}</td>
                                                <td className="border border-gray-300 p-3 text-right text-green-600 font-bold">
                                                    {totals.examTotal.toLocaleString()}k
                                                </td>
                                                <td className="border border-gray-300 p-3 text-right text-blue-600 font-semibold">
                                                    {totals.doctorTotal.toLocaleString()}k
                                                </td>
                                                <td className="border border-gray-300 p-3 text-right text-orange-600 font-semibold">
                                                    {totals.expenseTotal.toLocaleString()}k
                                                </td>
                                                <td className="border border-gray-300 p-3 text-right text-purple-600 font-semibold">
                                                    {totals.medicineTotal.toLocaleString()}k
                                                </td>
                                                <td className={`border border-gray-300 p-3 text-right font-bold ${totals.netTotal >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                                    {totals.netTotal.toLocaleString()}k
                                                </td>
                                            </tr>
                                        );
                                    })}
                                    {sortedDays.length > 0 && (
                                        <tr className="bg-gray-100 font-bold">
                                            <td className="border border-gray-300 p-3">T·ªîNG C·ªòNG</td>
                                            <td className="border border-gray-300 p-3 text-right text-green-600">
                                                {monthlyTotals.examTotal.toLocaleString()}k
                                            </td>
                                            <td className="border border-gray-300 p-3 text-right text-blue-600">
                                                {monthlyTotals.doctorTotal.toLocaleString()}k
                                            </td>
                                            <td className="border border-gray-300 p-3 text-right text-orange-600">
                                                {monthlyTotals.expenseTotal.toLocaleString()}k
                                            </td>
                                            <td className="border border-gray-300 p-3 text-right text-purple-600">
                                                {monthlyTotals.medicineTotal.toLocaleString()}k
                                            </td>
                                            <td className={`border border-gray-300 p-3 text-right ${monthlyTotals.netTotal >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                                {monthlyTotals.netTotal.toLocaleString()}k
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>
